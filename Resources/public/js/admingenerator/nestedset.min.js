;!function(e,t,n){function a(t,n){this._defaults={urls:{move:"/"},labels:{expand:"Expand",collapse:"Collapse"}},this._name=i,this.element=t,this.options=e.extend({},this._defaults,n),this._init()}var i="agen$nestedTree";a.prototype={_init:function(){this._treeInit(),this._dragNDropInit()},_treeInit:function(){var t=this;e(this.element).treeTable({stringExpand:this.options.labels.expand,stringCollapse:this.options.labels.collapse,doubleclickMode:!0,initialRootState:"expanded",initialIndent:-19,onNodeInit:function(e,n,a){t._treeOnNodeInitCallback(e,n,a)},onNodeReinit:function(e,n,a){t._treeOnNodeReinitCallback(e,n,a)}})},_treeOnNodeInitCallback:function(t,n,a){if(a?t.addClass("ui-helper-hidden"):"",n){var i=e(t).children().first(),r=e("<i />").addClass("glyphicon glyphicon-expander");i.append(r)}},_treeOnNodeReinitCallback:function(t){e(t).find(".glyphicon-expander").remove()},_dragNDropInit:function(){var t=this;e(this.element).find("tbody tr").draggable({helper:function(e){return t._dragHelperCallback(this,e)},drag:function(e,n){t._dragCallback(this,e,n)},refreshPositions:!0,revert:"invalid",revertDuration:300,scroll:!0}),e(this.element).find("tbody tr").droppable({accept:e(t.element).selector+" tbody tr",over:function(e,n){t._dropOverCallback(this,e,n)},out:function(e,n){t._dropOutCallback(this,e,n)},drop:function(e,n){t._dropCallback(this,e,n)}})},_dropIsAccepted:function(t,n,a){return n.nodeParent()&&n.nodeParent()[0].id==t[0].id&&"after"==this._dropActionName(a,t)?!1:-1==e.inArray(t,n.selectBranch())},_dropActionName:function(e,t){var n=e.draggable||e.helper.find("table tbody tr:first"),a=e.offset.top+n.outerHeight()/2,i=t.offset().top,r=t.outerHeight();return a>=i&&i+1*r/3>a?"before":a>=i+1*r/3&&i+2*r/3>=a?"in":a>i+2*r/3&&i+r>=a?"after":void 0},_dragHighlightAction:function(e,t){var n="droppable-"+this._dropActionName(e,t);t.removeClass("droppable-before").removeClass("droppable-in").removeClass("droppable-after").addClass(n)},_dragUnhighlightAction:function(e,t){e.draggable.removeData("current-droppable"),t.removeClass("droppable-before").removeClass("droppable-in").removeClass("droppable-after")},_dragHelperCallback:function(t,n){var a=e(n.target).closest("tr"),i=a.selectBranch();return e("<div />").addClass("nested-helper").css({width:i.closest("table").width()+"px",height:a.outerHeight()}).append(e("<table />").css("width","100%").append(i.clone()))},_dragCallback:function(t,n,a){var i=e(t),r=i.data("current-droppable");r&&this._dropIsAccepted(r,i,a)&&this._dragHighlightAction(a,r)},_dropOverCallback:function(t,n,a){var i=e(t),r=a.draggable;this._dropIsAccepted(i,r,a)&&(this._dragHighlightAction(a,i),r.data("current-droppable",i))},_dropOutCallback:function(t,n,a){var i=e(t),r=a.draggable;this._dropIsAccepted(i,r,a)&&this._dragUnhighlightAction(a,i)},_dropCallback:function(t,n,a){var i=e(t),r=a.draggable;if(this._dropIsAccepted(i,r,a)){this._dragUnhighlightAction(a,i);var o=this._dropActionName(a,i),d=this.options.urls.move;d=d.replace("|dragged|",r[0].id.replace("node-","")),d=d.replace("|dropped|",i[0].id.replace("node-","")),d=d.replace("|action|",o),e("#nestedset_loading").modal("show"),e.ajax({url:d,success:function(){var t=r.nodeParent();r.moveBranch(o,i),t&&t.nodeReinitialize(),"in"==o&&i.nodeReinitialize();var n=e("#nestedset_success").clone();e("#flashes").append(n),e("#nestedset_loading").modal("hide")},error:function(){var t=e("#nestedset_error").clone();e("#flashes").append(t),e("#nestedset_loading").modal("hide")}})}}},e.fn[i]=function(t){var r=arguments;if(t===n||"object"==typeof t)return this.each(function(){e.data(this,"plugin_"+i)||e.data(this,"plugin_"+i,new a(this,t))});if("string"==typeof t&&"_"!==t[0]&&"init"!==t){var o;return this.each(function(){var n=e.data(this,"plugin_"+i);n instanceof a&&"function"==typeof n[t]&&(o=n[t].apply(n,Array.prototype.slice.call(r,1))),"destroy"===t&&e.data(this,"plugin_"+i,null)}),o!==n?o:this}}}(jQuery,window);